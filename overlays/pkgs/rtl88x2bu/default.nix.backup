{ stdenv, fetchFromGitHub, linuxPackages, pkgs }:


let
  version = "1";
  date = "20200209";
  kernel = linuxPackages.kernel;
in
stdenv.mkDerivation rec {
  name = "rtl8822bu-${version}-${kernel.modDirVersion}";

  src = fetchFromGitHub {
    owner = "ulli-kroll";
    repo = "rtl8822bu";
    rev = "2ba08debec2ba05d8505e340c2438b4b8fe16c7d";
    sha256 = "067a98q1xljsx8ka579ah3h1y3kpbnv3ggyb7v073a3ddmxg6wki";
  };
  buildInputs = [ pkgs.bc ];

  configurePhase = ''
    kernel_version=${linuxPackages.kernel.modDirVersion}
    sed -i -e 's|/lib/modules|${linuxPackages.kernel.dev}/lib/modules|' Makefile
    sed -i -e 's|/lib/firmware|${linuxPackages.kernel.dev}/lib/firmware|' Makefile    
#    sed -i -e 's|installfw|install|' Makefile #makefile
    export makeFlags="BUILD_KERNEL=$kernel_version"
  '';

  installPhase = ''
    make installfw
    modprobe cfg80211
    insmod rtl8822bu.ko
  '';
}